<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Django Ollama Chat</title>
  <style>
    body { margin:0; font-family:sans-serif; display:flex; height:100vh; background:#1e1e1e; color:#eee; }
    #sidebar { width:260px; background:#252526; display:flex; flex-direction:column; }
    #sidebar header { padding:15px; border-bottom:1px solid #333; }
    #sidebar header button { width:100%; padding:10px; background:#007bff; border:none; border-radius:5px; color:#fff; cursor:pointer; }
    #history { flex:1; overflow-y:auto; }
    #history::-webkit-scrollbar { display:none; }
    .hist-item { padding:10px; border-bottom:1px solid #333; cursor:pointer; }
    .hist-item:hover { background:#333; }
    #sidebar footer { padding:10px; border-top:1px solid #333; display:flex; flex-direction:column; gap:8px; }
    #sidebar select, #sidebar input { width:100%; padding:8px; background:#2d2d2d; color:#fff; border:1px solid #444; border-radius:5px; }

    #main { flex:1; display:flex; flex-direction:column; }
    #chat { flex:1; overflow-y:auto; padding:15px; }
    #chat::-webkit-scrollbar { display:none; }
    .msg { display:flex; margin:8px 0; }
    .avatar { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:8px; flex-shrink:0; }
    .user .avatar { background:#007bff; color:#fff; }
    .bot .avatar { background:#555; color:#fff; }
    .bubble { padding:10px; border-radius:10px; max-width:70%; word-wrap:break-word; white-space:pre-wrap; }
    .user .bubble { background:#007bff; color:#fff; margin-left:auto; }
    .bot .bubble { background:#333; color:#fff; margin-right:auto; }

    footer { padding:10px; border-top:1px solid #333; display:flex; gap:10px; }
    textarea { flex:1; resize:none; padding:10px; border-radius:5px; background:#2d2d2d; color:#fff; border:1px solid #444; }
    button { padding:10px 15px; background:#007bff; border:none; border-radius:5px; color:#fff; cursor:pointer; }
    #fileBtn { background:#555; }
    #stats { font-size:12px; padding:5px 10px; background:#252526; border-top:1px solid #333; color:#bbb; }
  </style>
</head>
<body>
  <div id="sidebar">
    <header>
      <button id="newChatBtn">+ New Chat</button>
    </header>
    <div id="history"></div>
    <footer>
      <select id="model">
   
        <option value="deepseek-coder-v2:16b">DeepSeek</option>
        <option value="gpt-oss">Chat Gtp</option>

      </select>
      <input type="text" id="tunnelUrl" placeholder="Tunnel URL" value="/api/send_message/"/>
    </footer>
  </div>

  <div id="main">
    <div id="chat"></div>
    <footer>
      <input type="file" id="fileInput" hidden />
      <button id="fileBtn">üìé</button>
      <textarea id="message" rows="1" placeholder="Type message..."></textarea>
      <button id="sendBtn">Send</button>
    </footer>
    <div id="stats">‚è± First token: ‚Äì ms | ‚ö° Speed: ‚Äì tok/s</div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const historyDiv = document.getElementById("history");
    const messageInput = document.getElementById("message");
    const fileInput = document.getElementById("fileInput");
    const fileBtn = document.getElementById("fileBtn");
    const sendBtn = document.getElementById("sendBtn");
    const stats = document.getElementById("stats");

    async function loadHistory() {
      const res = await fetch("/api/history/");
      const data = await res.json();
      historyDiv.innerHTML = "";
      data.history.forEach((chatItem, idx) => {
        const div = document.createElement("div");
        div.className = "hist-item";
        div.textContent = chatItem.title || "Chat " + (idx+1);
        div.onclick = () => loadChat(chatItem.id);
        historyDiv.appendChild(div);
      });
    }

    async function loadChat(chatId) {
      const res = await fetch(`/api/history/${chatId}/`);
      const data = await res.json();
      chat.innerHTML = "";
      data.messages.forEach(msg => appendMessage(msg.role, msg.content, msg.file));
      chat.scrollTop = chat.scrollHeight;
    }

    function appendMessage(role, text, file=null) {
      const div = document.createElement("div");
      div.className = "msg " + role;
      div.innerHTML = `
        <div class="avatar">${role==="user"?"U":"ü§ñ"}</div>
        <div class="bubble">${text||""}</div>
      `;
      if (file) {
        const a = document.createElement("a");
        a.href = file;
        a.textContent = " üìé File";
        a.target = "_blank";
        div.querySelector(".bubble").appendChild(a);
      }
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
      const model = document.getElementById("model").value;
      const tunnelUrl = document.getElementById("tunnelUrl").value;
      const text = messageInput.value.trim();
      if (!text && fileInput.files.length===0) return;

      appendMessage("user", text);
      messageInput.value = "";
      
      const botDiv = document.createElement("div");
      botDiv.className = "msg bot";
      botDiv.innerHTML = `<div class="avatar">ü§ñ</div><div class="bubble"></div>`;
      chat.appendChild(botDiv);
      const bubble = botDiv.querySelector(".bubble");

      const formData = new FormData();
      formData.append("model", model);
      formData.append("message", text);
      if (fileInput.files.length>0) {
        formData.append("file", fileInput.files[0]);
        fileInput.value="";
      }

      const t0 = performance.now();
      let firstTokenTime = null;
      let tokens = 0;
      

      const response = await fetch(tunnelUrl, { method:"POST", body:formData });
      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while(true) {
        const {done, value} = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, {stream:true});
        if (!firstTokenTime) {
          firstTokenTime = performance.now() - t0;
          stats.textContent = `‚è± First token: ${firstTokenTime.toFixed(0)} ms | ‚ö° Speed: ‚Äì tok/s`;
        }
        bubble.innerHTML += chunk;
        tokens += chunk.split(/\s+/).length;
        chat.scrollTop = chat.scrollHeight;
      }

      if (firstTokenTime) {
        const totalTime = (performance.now()-t0)/1000;
        const speed = (tokens/totalTime).toFixed(2);
        stats.textContent = `‚è± First token: ${firstTokenTime.toFixed(0)} ms | ‚ö° Speed: ${speed} tok/s`;
      }
    }

    sendBtn.onclick = sendMessage;
    fileBtn.onclick = ()=>fileInput.click();
    messageInput.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    document.getElementById("newChatBtn").onclick = ()=>{ chat.innerHTML=""; };

    loadHistory();


    async function getStream() {
  const response = await fetch("/chat-stream");
  const reader = response.body.getReader();
  const decoder = new TextDecoder();

  let result = "";
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    result += decoder.decode(value, { stream: true });
    console.log(result); // partial response
  }
}

  </script>
</body>
</html>
